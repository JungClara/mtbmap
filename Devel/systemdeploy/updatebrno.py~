#!/usr/bin/python

#-------------------------------------------------------------------------
# script updates (or creates) database data with yesterdays Czech extract 
# from planet.osm file available on osm.kyblsoft.cz/archiv
# Very simple solution, no update is performed on the 1st day of a month.
#
# Edit paths for your local settings, make sure you have relations2lines.py
# script downloaded, if you need to display paralell tracks with Mapnik
#
# Edit osm2pgsql default.style file to upload attributes you need
#
# to download different dataset, more changes will be needed

import os, sys, re
from time import localtime

def refreshDate(filepath,date):
    fo = open(filepath,'r')
    s = fo.read()
    fo.close()
    fo = open(filepath,'w')
    fo.write(re.sub("20[1-9][0-9]-[0-1][0-9]-[0-3][0-9]",date,s))
    fo.close()

if __name__ == "__main__":
    homepath = '/home/xtesar7'
    time = localtime()
    day = time[2]
    month = time[1]
    if month < 10:
        month = '0'+str(month)
    else:
        month = str(month)
    if (day != 1):
        day = day-1
        if day < 10:
            day = '0'+str(day)
        else:
            day = str(day)
        date = str(time[0]) + '-'+ month + '-' + day

        url = 'http://osm.kyblsoft.cz/archiv/czech_republic-' + date + '.osm.bz2'
        url = 'http://osm.kyblsoft.cz/archiv/czech_republic-2010-06-30.osm.bz2'
#        filename = 'czech_republic-' + date + '.osm.bz2'
        filename = 'brno.osm.gz'
        os.chdir(homepath + '/Data')
        print os.getcwd()
#        os.system('wget ' + url)
        os.chdir(homepath + '/sw/osm2pgsql')
        os.system('./osm2pgsql -s -d gisczech ../../Data/' + filename + ' -S ./default.style')
#        os.remove('../../Data/' + filename)
        os.system(homepath + '/Devel/relations2lines.py')
        refreshDate(homepath + '/Web/mtbmap/index.html',date)
        refreshDate(homepath + '/Web/mtbmap/en.html',date)
        # restart renderd:
        os.chdir(homepath + '/sw/mod_tile')
        os.system('kill $(pidof renderd)')
        os.system('./renderd')

